<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Workshop</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap-4/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="src/datepickr.min.css">

</head>

<body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class=" navbar-brand " href="index.html">Emergency</a>
        <button class="navbar-toggler " type="button " data-toggle="collapse " data-target="#navbarSupportedContent " aria-controls="navbarSupportedContent " aria-expanded="false " aria-label="Toggle navigation ">
        <span class="navbar-toggler-icon "></span>
      </button>

        <div class="collapse navbar-collapse " id="navbarSupportedContent ">
            <ul class="navbar-nav mr-auto ">
                <li class="nav-item ">
                    <a class="nav-link " href="search_patient.html ">Patient </a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link " href="search_observation_v4.html ">Observation <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link " href="CDA_viewer.html">CDA </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link " href="chart.html">Chart </a>
                </li>
            </ul>
            <form class="form-inline my-2 my-lg-0 ">
                <input class="form-control mr-sm-2 " type="text " placeholder="Search " aria-label="Search ">
                <button class="btn btn-outline-success my-2 my-sm-0 " type="submit ">Search</button>
            </form>
        </div>
    </nav>
    <br>
    <br>

    <div class="container">
        <script src="src/datepickr.min.js"></script>
        <script src="src/datepickr.js"></script>

        <h2>Observation</h2>
        <button type="button" class="btn btn-outline-success float-right" onclick="showForm()">Add Heart rate</button>
        <button type="button" class="btn btn-outline-success float-right" onclick="showPressure()">Add Pressure</button>
        <div id="myFORM" style="display: none;">
            <br>
            <br>
            <h4><strong>Create Heart rate Observation</strong></h4>
            <br>

            <div class="form-row">
                <div class="col-3">
                    <label class="sr-only" for="inlineFormInputGroup">Heart rate</label>
                    <input id="rate" type="text" class="form-control mb-2 mb-sm-0" id="inlineFormInput" placeholder="beats/minute">
                </div>
                <div class="col-3">
                    <p><input id="datepickr" class="form-control mb-2 mb-sm-0" id="inlineFormInput" placeholder="effectiveDateTime"></p>
                </div>
                <script>
                    datepickr('#datepickr', {
                        dateFormat: 'Y-m-d'
                    });

                </script>
                <div class="col">
                    <input type="submit" accept="image/*" class="btn btn-primary" onClick="addResourceToServer();" value="Create Observation">
                </div>
            </div>

        </div>
        <div id="Form-Pressure" style="display: none;">
            <br>
            <br>
            <h4><strong>Create Blood pressure Observation</strong></h4>
            <br>

            <div class="form-row">
                <div class="col-3">
                    <label class="control-label ">Body Site</label>
                    <div class="radio">
                        <label class="radio">
                       <input name="radio" type="radio" value="right"/>
                       Right arm
                      </label>
                    </div>
                    <div class="radio">
                        <label class="radio">
                       <input name="radio" type="radio" value="left"/>
                       Left arm
                      </label>
                    </div>
                </div>
                <div class="col-3">
                    <label class="control-label" for="name">Systolic blood pressure</label>
                    <input id="systolic" required class="form-control" type="text" placeholder="mm[Hg]">
                </div>
                <div class="col-3">
                    <label class="control-label" for="name">Diastolic blood pressure</label>
                    <input id="diastolic" required class="form-control" type="text" placeholder="mm[Hg]">
                </div>
                <div class="col-3">
                    <label class="control-label" for="name">Date</label>
                    <p><input id="datepickr" class="form-control mb-2 mb-sm-0" id="inlineFormInput" placeholder="effectiveDateTime"></p>
                </div>
                <script>
                    datepickr('#datepickr', {
                        dateFormat: 'Y-m-d'
                    });

                </script>
                <div class="col">
                    <input type="submit" accept="image/*" class="btn btn-primary" onClick="addPressure();" value="Create Observation">
                </div>
            </div>

        </div>

        <br/>
        <br/>

        <h4>Patient Information</h4>
        <table id="patient-table" class="table table-striped table-responsive ">
            <thead class="thead-inverse">
                <tr>
                    <th>id</th>
                    <th>Given Name</th>
                    <th>Family Name</th>
                    <th>Date of birth</th>
                </tr>

            </thead>

            <tbody>

            </tbody>

        </table>
        <br/>
        <br/>

        <button type="button" class="btn btn-warning btn-lg float-right" onclick="loadList()">Refresh</button>
        <br/>
        <br/>

        <h4>Heart rate information</h4>
        <table id="observation-table" class="table table-striped table-responsive ">
            <thead class="thead-inverse">
                <tr>
                    <th>id</th>
                    <th>Name</th>
                    <th>Value Quantity</th>
                    <th>Unit</th>
                </tr>

            </thead>

            <tbody>

            </tbody>

        </table>
        <br/>
        <br/>

        <h4>Blood pressure information</h4>
        <table id="pressure-table" class="table table-striped table-responsive ">
            <thead class="thead-inverse">
                <tr>
                    <th>id</th>
                    <th>BodySite</th>
                    <th>Systolic</th>
                    <th>Unit</th>
                    <th>Diastolic</th>
                    <th>Unit</th>
                </tr>

            </thead>

            <tbody>

            </tbody>

        </table>


    </div>

    <script src="lib/jquery/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script src="lib/fhir-client/fhir-client.min.js"></script>
    <script src="js/config_FHIR.js"></script>
    <script src="js/fhir-util.js"></script>

    <script>
        "use strict ";
        var xs = "0";
        var loadList = function() {

            var x = location.search;
            if (x.length != "0") {
                xs = x.slice(1);
            } else {
                var smart = FHIR.client(config);
                var queryObject = {
                    _sort: "-_lastUpdated"
                };

                smart.api.search({
                        type: "Patient",
                        query: queryObject
                    })
                    .then(function(response) {

                        if (response.data.total != "0") {
                            xs = (response.data.entry[0].resource.id).toString();
                            console.log("inside " + xs);

                        }
                    });
                //xs = "EXf201"; //identificar el paciente mas actual (resource: meta: _lastUpdated)
                console.log("outside " + xs);

            }

            $("#observation-table tbody").empty();
            $("#patient-table tbody").empty();

            var smart = FHIR.client(config);
            var patientId = $("#patientId").val();

            //buscar que campos estan con valores para generar la query
            var queryObject = {
                subject: xs,
                _sort: "-_lastUpdated"
            };
            var queryObjectPatient = {
                _id: xs
            };

            smart.api.search({
                    type: "Patient",
                    query: queryObjectPatient
                })
                .then(function(response) {
                    // Handle response for Patient Information
                    console.log(response);
                    var i = 0;
                    for (i = 0; i < response.data.total; i++) {
                        appendRowPatient(response.data.entry[i].resource.id, response.data.entry[i].resource.name[0].given[0], response.data.entry[i].resource.name[0].family, response.data.entry[i].resource.birthDate);
                    }
                });

            smart.api.search({
                    type: "Observation",
                    query: queryObject
                })
                .then(function(response) {
                    // Handle response for Hearth rate information 
                    var i = 0;
                    if (response.data.total != "0") {
                        for (i = 0; i < (response.data.entry.length); i++) {
                            if (typeof response.data.entry[i].resource.code.text != "undefined") {
                                if (response.data.entry[i].resource.code.text == "Heart rate") {
                                    appendRow(response.data.entry[i].resource.id, response.data.entry[i].resource.code.text, response.data.entry[i].resource.valueQuantity.value, response.data.entry[i].resource.valueQuantity.unit);
                                }
                            }
                        }
                    }
                });

            smart.api.search({
                    type: "Observation",
                    query: queryObject
                })
                .then(function(response) {
                    // Handle response for Blood pressure information
                    var i = 0;
                    if (response.data.total != "0") {

                        for (i = 0; i < (response.data.entry.length); i++) {
                            if (typeof response.data.entry[i].resource.code.coding != "undefined") {
                                if (response.data.entry[i].resource.code.coding["0"].code == "85354-9") {
                                    appendRow_pressure(response.data.entry["0"].resource.id, response.data.entry[i].resource.bodySite.coding["0"].display, response.data.entry[i].resource.component["0"].valueQuantity.value, response.data.entry[i].resource.component["0"].valueQuantity.unit, response.data.entry[i].resource.component[1].valueQuantity.value, response.data.entry[i].resource.component[1].valueQuantity.unit);
                                }
                            }
                        }
                    }
                });
        };
        var appendRow = function(id, name, ValueQuantity, unit) {
            $("#observation-table").find("tbody").append("<tr><td>" + (id || '-') + " </td><td>" + (name || '-') + "</td><td>" + (ValueQuantity || '-') + "</td><td>" + (unit || '-') + "</td></tr>")
        };
        var appendRowPatient = function(id, given, family, dateOfBirth) {
            $("#patient-table").find("tbody").append("<tr><td>" + (id || '-') + "</td><td>" + (given || '-') + "</td><td>" + (family || '-') + "</td><td>" + (dateOfBirth || '-') + "</td></tr>")
        };
        var appendRow_pressure = function(id, BodySite, Systolic, Unit, Diastolic, Unit) {
            $("#pressure-table").find("tbody").append("<tr><td>" + (id || '-') + " </td><td>" + (BodySite + " arm" || '-') + "</td><td>" + (Systolic || '-') + "</td><td>" + (Unit || '-') + "</td><td>" + (Diastolic || '-') + "</td><td>" + (Unit || '-') + "</td></tr>")
        };

        function showForm() {
            var x = document.getElementById('myFORM');
            if (x.style.display === 'none') {
                x.style.display = 'block';
            } else {
                x.style.display = 'none';
            }
        }

        function showPressure() {
            var x = document.getElementById('Form-Pressure');
            if (x.style.display === 'none') {
                x.style.display = 'block';
            } else {
                x.style.display = 'none';
            }
        }

        var addResourceToServer = function() {

            var x = location.search;
            if (x.length != "0") {
                var xs = x.slice(1);
            } else {
                xs = "EXpat1";
            }

            var smart = FHIR.client(config);

            var observation = {
                resourceType: "Observation",
                status: "final",
                code: {
                    text: "Heart rate"
                },
                effectiveDateTime: $("#datepickr").val(),
                valueQuantity: [{
                    value: $("#rate").val(),
                    unit: "beats/minute",
                    system: "http://unitsofmeasure.org",
                    code: "/min"
                }],
                subject: [{
                    reference: "Patient/" + xs
                }]
            };
            console.log(observation);
            smart.api.create({
                resource: observation
            }).then(function(response) {
                // Executed after query completed
                // Handle response here
                console.log(response);
            });

            return false;
        };

        var addPressure = function() {

            var x = location.search;
            console.log(x);
            if (x.length != "0") {
                var xs = x.slice(1);
                console.log(xs);
            } else {
                xs = "EXpat1";
            }

            var smart = FHIR.client(config);

            var observation = {
                resourceType: "Observation",
                status: "final",
                code: {
                    coding: [{
                        system: "http://loinc.org",
                        code: "85354-9",
                        display: "Bood pressure panel with all children optional"
                    }],
                    text: "Blood pressure systolic & diastolic"
                },
                effectiveDateTime: $("#datepickr").val(),
                subject: [{
                    reference: "Patient/" + xs
                }],
                bodySite: {
                    coding: [{
                        system: "http://snomed.info/sct",
                        code: "368209003",
                        display: $('input[name=radio]:checked').val()
                    }]
                },
                component: [{
                        code: {
                            coding: [{
                                system: "http://loinc.org",
                                code: "8480-6",
                                display: "Systolic blood pressure"
                            }]
                        },
                        valueQuantity: {
                            value: $("#systolic").val(),
                            unit: "mmHg",
                            system: "http://unitsofmeasure.org",
                            code: "mm[Hg]"
                        }
                    },
                    {
                        code: {
                            coding: [{
                                system: "http://loinc.org",
                                code: "8462-4",
                                display: "Diastolic blood pressure"
                            }]
                        },
                        valueQuantity: {
                            value: $("#diastolic").val(),
                            unit: "mmHg",
                            system: "http://unitsofmeasure.org",
                            code: "mm[Hg]"
                        }
                    }
                ]
            };
            console.log(observation);
            smart.api.create({
                resource: observation
            }).then(function(response) {
                // Executed after query completed
                // Handle response here
                console.log(response);
            });

            return false;
        };

        $(document).ready(function() {
            loadList();
        }); // $("#submit ").click(loadList());

    </script>

</body>

</html>
